{% extends 'home/base.html' %}
{% load static %}

{% block title %}Minhas Tarefas - FocusUP{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'home/css/estilotarefas.css' %}?v=2" />
{% endblock extra_head %}


{% block content %}
    <div class="container-tarefas" 
         data-ajax-url-gerar="{% url 'home:adicionar_Tarefas' %}" 
         data-ajax-url-salvar="{% url 'home:adicionar_Tarefas' %}" 
         data-csrf-token="{{ csrf_token }}"
         
         data-slots-usados="{{ slots_usados }}"
         data-slots-limite="{{ slots_limite }}">
        
        <h1>Minhas Tarefas</h1>

        <div class="contador-slots-container" id="contador-slots-container">
            <h3 class="contador-titulo">Slots de Tarefas Pessoais (Hoje)</h3>
            <div class="contador-visual" id="contador-slots-visual">
                {{ slots_usados }} / {{ slots_limite }}
            </div>
        </div>
        
        <a href="{% url 'home:adicionar_Tarefas' %}" class="link-adicionar link-botao" style="margin-bottom: 1rem;">
            Gerenciar Tarefas Pessoais (Recorrentes)
        </a>
        {% if slots_usados < slots_limite %}
        
        <div id="area-adicionar-tarefas"> 
            <section class="secao-sugestao-ia">
                <h2>Sugestão Rápida da IA (Usa 1 Slot)</h2>
                <div class="container-gerar-ia-lista">
                    <select id="seletor-foco-ia-lista" aria-label="Selecione o perfil de foco para a IA">
                        <option value="">Selecione um Foco...</option>
                        {% for perfil in perfis_usuario %}
                            <option value="{{ perfil.foco_nome }}">{{ perfil.foco_nome|capfirst }}</option>
                        {% empty %}
                            <option value="" disabled>Cadastre Perfis de Foco!</option>
                        {% endfor %}
                    </select>
                    <button id="botao-gerar-ia-lista" class="botao-gerar-ia-lista" disabled>Sugerir Tarefa</button>
                </div>
                <div id="area-sugestao-lista" style="display: none;">
                </div>
                <div id="feedback-ia-lista"></div>
                <div class="botoes-sugestao">
                    <button id="botao-aceitar-lista" class="botao-aceitar-lista">Adicionar esta Tarefa</button>
                    <button id="botao-dispensar-lista" class="botao-dispensar-lista">Dispensar</button>
                </div>
            </section>
        </div>

        {% else %}
        
        <div class="limite-slots-mensagem" id="limite-slots-mensagem">
            <p>Você atingiu seu limite de 3 tarefas pessoais por hoje!</p>
            <p>Novos slots estarão disponíveis após o reset diário.</p>
        </div>
        
        {% endif %}
        
        
        <h2 class="titulo-secao-lista">Tarefas de Hoje</h2>
        <ul class="lista-tarefas" id="lista-tarefas-ul">
            {% for tarefa in tarefas %}
            
            <li class="item-tarefa {% if tarefa.falhou %}tarefa-falhada{% endif %}" id="tarefa-{{ tarefa.id_Tarefa }}">
                
                <div class="tarefa-info">
                    <span class="tarefa-titulo"> {{ tarefa.titulo }} </span>
                    <div class="tarefa-detalhes">
                        
                        <div class="info-bloco xp-bloco">
                            <span class="info-label">XP</span>
                            <span class="info-valor">{{ tarefa.xp|default:0 }}</span>
                        </div>
                        
                        {% if tarefa.descricao %}
                            <p class="task-description-full" data-fulltext="{{ tarefa.descricao|escape }}">
                                {{ tarefa.descricao }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                
                {% if tarefa.falhou %}
                    <div class="botoes-tarefa-container">
                        <form method="POST" action="{% url 'home:descartar_tarefa' tarefa.id_Tarefa %}" class="formulario-descartar">
                            {% csrf_token %}
                            <button type="submit" class="botao-tarefa botao-descartar">
                                Descartar
                            </button>
                        </form>
                        
                        <form method="POST" action="{% url 'home:concluir_atrasado' tarefa.id_Tarefa %}" class="formulario-concluir-atrasada">
                            {% csrf_token %}
                            <button type="submit" class="botao-tarefa botao-concluir-atrasada">
                                Concluir (sem XP)
                            </button>
                        </form>
                    </div>
                
                {% else %}
                    <form method="POST" action="{% url 'home:concluir_tarefa' tarefa.id_Tarefa %}" class="formulario-concluir">
                        {% csrf_token %}
                        <button type="submit" class="botao-tarefa botao-concluir">
                            Concluir
                        </button>
                    </form>
                {% endif %}
                
            </li>
            {% empty %}
            <li class="item-tarefa-vazia" id="lista-tarefas-vazia">
                <p>Você ainda não tem tarefas para hoje.</p>
                <p>Crie tarefas recorrentes na página "Gerenciar Tarefas" ou aguarde suas Quests Diárias!</p>
            </li>
            {% endfor %}
        </ul>
    </div>
{% endblock content %}


{% block extra_scripts %}
    <script src="{% static 'home/js/lista_tarefas_ai.js' %}"></script>
{% endblock extra_scripts %}